import{r,j as i}from"./vendor-react-XZtyZRd7.js";import{F as W}from"./FeedbackModal-CktddIhx.js";import{u as _,a as z}from"./vendor-web3-Dys35WFk.js";const D={en:{claimButton:"✅ Claim completion",claimingButton:"Signing…",successMessage:"✔ Completion recorded successfully",checkingStatus:"Checking completion status…",completedOn:"Completed on:",walletNotConnectedError:"Wallet not connected",labIdMissingError:"Lab ID missing",backendError:"Failed to record completion",backToOverview:"⬅ Back to lab overview"},gr:{claimButton:"✅ Δήλωση Ολοκλήρωσης",claimingButton:"Υπογραφή…",successMessage:"✔ Η ολοκλήρωση καταγράφηκε επιτυχώς",checkingStatus:"Έλεγχος κατάστασης ολοκλήρωσης…",completedOn:"Ολοκληρώθηκε στις:",walletNotConnectedError:"Το πορτοφόλι δεν είναι συνδεδεμένο",labIdMissingError:"Λείπει το Lab ID",backendError:"Αποτυχία καταγραφής ολοκλήρωσης",backToOverview:"⬅ Επιστροφή στην επισκόπηση"}};function H({labId:n,language:k="en",backHref:S=null,backLabel:F=null,labTitle:B=null}){const a=D[k]||D.en,m="https://web3edu-api.dimikog.org",{address:c,isConnected:g}=_(),{signMessageAsync:L}=z(),[f,y]=r.useState(!1),[w,C]=r.useState(!1),[v,u]=r.useState(null),[h,E]=r.useState(!0),[M,j]=r.useState(null),[N,p]=r.useState(!1),[T,O]=r.useState(!1);r.useEffect(()=>{if(!g||!c||!n){E(!1);return}(async()=>{try{const e=await fetch(`${m}/labs/status?address=${c}&labId=${n}`);if(!e.ok)return;const l=await e.json();l.completed===!0&&(C(!0),j(l.completedAt||null))}catch(e){console.warn("Failed to restore lab completion state",e)}finally{E(!1)}})()},[m,g,c,n]),r.useEffect(()=>{if(!N)return;const s=1800,e=120,l=Date.now(),b=["#22c55e","#38bdf8","#a78bfa","#f59e0b","#f43f5e"],I=Array.from({length:e},()=>({x:Math.random()*window.innerWidth,y:-20-Math.random()*window.innerHeight*.4,r:2+Math.random()*5,vy:2+Math.random()*3,vx:-1.25+Math.random()*2.5,tilt:Math.random()*Math.PI*2,spin:-.1+Math.random()*.2,color:b[Math.floor(Math.random()*b.length)]})),t=document.createElement("canvas");t.width=window.innerWidth,t.height=window.innerHeight,t.style.position="fixed",t.style.inset="0",t.style.pointerEvents="none",t.style.zIndex="90",document.body.appendChild(t);const d=t.getContext("2d");if(!d){t.remove(),p(!1);return}const $=()=>{t.width=window.innerWidth,t.height=window.innerHeight};window.addEventListener("resize",$);let x=0;const A=()=>{d.clearRect(0,0,t.width,t.height),I.forEach(o=>{o.x+=o.vx+Math.sin(o.tilt)*.5,o.y+=o.vy,o.tilt+=o.spin,d.fillStyle=o.color,d.beginPath(),d.ellipse(o.x,o.y,o.r,o.r*.65,o.tilt,0,Math.PI*2),d.fill()}),Date.now()-l<s?x=requestAnimationFrame(A):p(!1)};return x=requestAnimationFrame(A),()=>{cancelAnimationFrame(x),window.removeEventListener("resize",$),t.remove()}},[N]),r.useEffect(()=>{if(h||!n||!c)return;const s=localStorage.getItem(`feedback_${n}`)==="true",e=localStorage.getItem(`feedback_prompted_${n}`)==="true";s||e||O(!0)},[h,n,c]);const P=async()=>{if(!w){if(!g||!c){u(a.walletNotConnectedError);return}if(!n){u(a.labIdMissingError);return}y(!0),u(null);try{const s=new Date().toISOString(),e=`I confirm completion of Web3Edu Lab
Lab ID: ${n}
Address: ${c}
Timestamp: ${s}`,l=await L({message:e});if(!(await fetch(`${m}/labs/complete`,{method:"POST",headers:{"Content-Type":"application/json","X-API-KEY":"1234567890DimtrisK240678Maria2806201809876543210"},body:JSON.stringify({address:c,labId:n,message:e,signature:l})})).ok)throw new Error("Backend rejected completion");C(!0),j(new Date().toISOString()),p(!0)}catch(s){console.error(s),u(a.backendError)}finally{y(!1)}}};return i.jsxs("div",{className:"mt-4",children:[h&&i.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400",children:a.checkingStatus}),!w&&!h&&i.jsx("button",{onClick:P,disabled:f,className:`px-5 py-2 rounded-md font-semibold text-white transition ${f?"bg-slate-400 cursor-not-allowed":"bg-green-600 hover:bg-green-700"}`,children:f?a.claimingButton:a.claimButton}),w&&i.jsxs("div",{className:"rounded-xl border border-green-300/60 dark:border-green-700/40 bg-green-50 dark:bg-green-900/20 p-4",children:[i.jsx("p",{className:"font-semibold text-green-700 dark:text-green-400",children:a.successMessage}),M&&i.jsxs("p",{className:"text-xs mt-1 text-green-600 dark:text-green-400",children:[a.completedOn," ",new Date(M).toLocaleString()]})]}),v&&i.jsx("p",{className:"mt-3 text-sm text-red-600 dark:text-red-400",children:v}),S&&i.jsx("a",{href:S,className:"inline-block mt-4 px-4 py-2 rounded-md bg-slate-700 text-white hover:bg-slate-800",children:F||a.backToOverview}),i.jsx(W,{isOpen:T,onClose:()=>{n&&localStorage.setItem(`feedback_prompted_${n}`,"true"),O(!1)},labId:n,labTitle:B,language:k,onSubmit:async s=>{const e=await fetch(`${m}/feedback`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!e.ok)throw new Error(`Feedback request failed with status ${e.status}`)}})]})}export{H as L};
